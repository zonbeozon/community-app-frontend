version: '3.8' # Docker Compose 파일 형식 버전

services:
  s3mock:
    image: adobe/s3mock # S3Mock Docker 이미지 사용
    container_name: s3mock-dev-server # 사용자 스크립트와 동일한 컨테이너 이름 사용
    ports:
      - "9090:9090" # HTTP 포트 매핑
      - "9191:9191" # HTTPS 포트 매핑 (필요시)
    environment:
      # S3Mock이 시작될 때 자동으로 생성할 버킷 목록
      COM_ADOBE_TESTING_S3MOCK_STORE_INITIALBUCKETS: "mock-image-bucket"
    networks:
      - app-network # 애플리케이션과 동일한 네트워크에 연결

  app:
    image: aaasssk/zonbeozon:latest
    ports:
      - "8080:8080" # 호스트의 8080 포트를 컨테이너의 8080 포트에 매핑
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Spring Boot 애플리케이션이 MySQL에 연결하기 위한 환경 변수 설정
      # 이 변수들은 application.properties/yml에서 ${DB_HOST} 등으로 참조됩니다.
      SPRING_PROFILES_ACTIVE: local,cache,mocks3
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/zonbeozon
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 1234
      DOCKER_S3MOCK_URL: s3mock:9090
      EXTERNAL_S3MOCK_URL: localhost:9090
    networks:
      - app-network # 두 서비스가 통신할 수 있도록 동일한 네트워크에 연결

  # MySQL 데이터베이스 서비스 정의
  db:
    image: mysql:8.0 # MySQL 8.0 버전 이미지 사용
    ports:
      - "3307:3306" # 호스트의 3307 포트를 컨테이너의 3306 포트에 매핑 (선택 사항, 내부 통신만 필요하면 제거 가능)
    environment:
      MYSQL_ROOT_PASSWORD: 1234 # MySQL root 계정 비밀번호
      MYSQL_DATABASE: zonbeozon # 생성할 데이터베이스 이름
      MYSQL_USER: zon # 생성할 사용자 이름
      MYSQL_PASSWORD: 1234 # 생성할 사용자 비밀번호
    volumes:
      - db-data:/var/lib/mysql # 데이터베이스 데이터를 호스트 볼륨에 영구 저장
      # - ./mysql_init:/docker-entrypoint-initdb.d # 초기 스키마/데이터를 위한 SQL 파일이 있다면 주석 해제
    networks:
      - app-network # 두 서비스가 통신할 수 있도록 동일한 네트워크에 연결
    healthcheck: # Healthcheck 추가 (이전 답변 참조)
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p1234" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

volumes:
  db-data:

# 네트워크 정의 (서비스 간 통신을 위함)
networks:
  app-network: